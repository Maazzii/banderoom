<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0/EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.mapper.spaceMapper">
	<insert id="spaceReg" parameterType="spacesVO" useGeneratedKeys="true" keyProperty="idx">
	
		insert into spaces (
			type,
			name,
			address,
			<if test="addressDetail != null">
				addressdetail,
			</if>
			addr1,
			<if test="addr2 != null">
				addr2,
			</if>
			info,
			facility,
			caution,
			capacity,
			cost,
			<if test="thumb != null">
				thumb,
			</if>
			hostidx
		) values (
			#{type},
			#{name},
			#{address},
			<if test="addressDetail != null">
				#{addressDetail},
			</if>
			#{addr1},
			<if test="addr2 != null">
				#{addr2},
			</if>
			#{info},
			#{facility},
			#{caution},
			#{capacity},
			#{cost},
			<if test="thumb != null">
				#{thumb},
			</if>
			#{hostIdx}
		)
	</insert>
	
	<update id="update" parameterType="spacesVO">
		update spaces set
		
			<if test="thumb != null and thumb != ''">
				thumb = #{thumb},
			</if>
			<if test="thumb == null or thumb == ''">
				thumb = '',
			</if>
			type = #{type},
			name = #{name},
			address = #{address},
			<if test="addressDetail != null and addressDetail != ''">
				addressdetail = #{addressDetail},
			</if>
			<if test="addressDetail == null or addressDetail == ''">
				addressdetail = '',
			</if>
			addr1 = #{addr1},
			<if test="addr2 != null and addr2 != ''">
				addr2 = #{addr2},
			</if>
			<if test="addr2 == null or addr2 == ''">
				addr2 = '',
			</if>
			info = #{info},
			facility = #{facility},
			caution = #{caution},
			capacity = #{capacity},
			cost = #{cost}
		
		where idx = #{idx}
	</update>
	
	<insert id="insertSpacePictures" parameterType="spacePicturesVO">
		insert into space_pictures (
			spaceidx,
			src,
			thumbsrc
		) values (
			#{spaceIdx},
			#{src},
			#{thumbSrc}
		)
	</insert>
	
	<delete id="deleteSpacePictrues" parameterType="spacesVO">
		delete from space_pictures
		where spaceidx = #{idx}
	</delete>
	
	<select id="getLocations" resultType="locationsVO">
		select * from locations order by addr1, addr2
	</select>
	
	<select id="getSpaceList" resultType="spacesVO" parameterType="spacesVO">
		select idx,
					 type,
					 name,
					 address,
					 addressdetail,
					 addr1,
					 addr2,
					 info,
					 facility,
					 caution,
					 capacity,
					 cost,
					 regdate,
					 hostidx,
					 status,
					 thumb
		from spaces 
		where status != 3
			<if test="hostIdx != 0">
			and hostidx = #{hostIdx}
			</if>
	</select>
	
	<select id="details" resultType="spacesVO" parameterType="spacesVO">
		select idx,
					 type,
					 name,
					 address,
					 addressdetail,
					 addr1,
					 addr2,
					 info,
					 facility,
					 caution,
					 capacity,
					 cost,
					 regdate,
					 hostidx,
					 status,
					 thumb
		from spaces
		where idx = #{idx}
	</select>
	
	<select id="spacePictureList" resultType="spacePicturesVO" parameterType="spacesVO">
		select pictureidx,
					 spaceidx,
					 src,
					 thumbsrc
		from space_pictures
		where spaceidx = #{idx}
	</select>
	
	<update id="delete" parameterType="spacesVO">
		update spaces set status = 3 where idx = #{idx}
	</update>
	
	<select id="likedSpacesList" parameterType="spacesVO" resultType="likedSpacesVO">
		select spaceidx, midx
		from liked_spaces
		where spaceidx = #{idx}
	</select>
	
	<select id="getLikedStatus" parameterType="likedSpacesVO" resultType="int">
		select count(*) from liked_spaces
		where spaceidx = #{spaceIdx} and midx = #{mIdx}
	</select>
	
	<insert id="likeSpace" parameterType="likedSpacesVO">
		insert into liked_spaces (
			spaceidx,
			midx
		) values (
			#{spaceIdx},
			#{mIdx}
		)
	</insert>
	
	<delete id="unlikeSpace" parameterType="likedSpacesVO">
		delete from liked_spaces
		where spaceidx = #{spaceIdx} and midx = #{mIdx}
	</delete>
	
	<update id="acceptSpace" parameterType="spacesVO">
		update spaces
		set status = 1
		where idx = #{idx}
	</update>
	
	<update id="refuseSpace" parameterType="spacesVO">
		update spaces
		set status = 2
		where idx = #{idx}
	</update>
	
	<update id="requestAccept" parameterType="spacesVO">
		update spaces
		set status = 0
		where idx = #{idx}
	</update>
	
	<select id="spaceList" resultType="spacesVO" parameterType="HashMap">
		select * from (
			select row_number() over(order by idx) as rownum, s.*
			from spaces s
			
			<if test="vo != null">
				<if test="liked != null and liked != ''">
				, liked_spaces ls
				</if>
			</if>
			
			where s.status = 1
			
			<if test="vo != null">
				
				<if test="liked != null and liked != ''">
				and s.idx = ls.spaceidx
				and ls.midx = #{liked.mIdx}
				</if>
				<if test="vo.addr1 != null and vo.addr1 != ''">
				and addr1 = #{vo.addr1}
				</if>
				<if test="vo.addr2 != null and vo.addr2 != ''">
				and addr2 = #{vo.addr2}
				</if>
				<if test="vo.type != null and vo.type != ''">
				and type = #{vo.type}
				</if>
				<if test="vo.name != null and vo.name != ''">
				and name like concat('%', #{vo.name}, '%')
				</if>
				
			</if>
			
		) a where a.rownum <![CDATA[>=]]> #{start} and a.rownum <![CDATA[<=]]> #{end}
	</select>
	
	<select id="spaceReviewCntAvg" parameterType="spacesVO" resultType="Map">
		select spaceidx, count(score) as count, avg(score) as avg from space_review where spaceidx = #{idx} group by spaceidx 
	</select>
	
	<select id="spaceReviewList" parameterType="hashmap" resultType="spaceReviewVO">
		select gm.profilesrc,
					 sr.residx,
					 sr.spaceidx,
					 sr.picturesrc,
					 sr.thumbsrc,
					 sr.score,
					 sr.midx,
					 sr.mnickname,
					 sr.content,
					 sr.regdate
		from general_members gm, space_review sr
		where spaceidx = #{spacesVO.idx}
		and gm.midx = sr.midx
		<if test="orderType == 'regDateDesc'">
			order by regdate desc
		</if>
		<if test="orderType == 'scoreAsc'">
			order by score
		</if>
		<if test="orderType == 'scoreDesc'">
			order by score desc
		</if>
		limit #{start}, 5
	</select>
	
	<!-- 테스트용 -->
	<select id="getAddr1" resultType="String">
		select distinct addr1 from locations;
	</select>
	
	<select id="getAddr2" parameterType="locationsVO" resultType="String">
		select addr2 from locations where addr1 = #{addr1}
	</select>
	
	<insert id="insertRsv" parameterType="reservationsVO" useGeneratedKeys="true" keyProperty="resIdx">
		insert into reservations(
			midx,
			spaceidx,
			peoplenum,
			startdate,
			enddate,
			rsvhours,
			cost,
			usedpoint,
			totalcost
		) values (
			#{mIdx},
			#{spaceIdx},
			#{peopleNum},
			#{startDate},
			#{endDate},
			#{rsvHours},
			#{cost},
			#{usedPoint},
			#{totalCost}
		)
	</insert>
	
	<insert id="insertPoint" parameterType="pointsVO">
		insert into points (
			residx,
			midx,
			content,
			amount,
			balance
		) values (
			#{resIdx},
			#{mIdx},
			#{content},
			#{amount},
			#{balance}
		)
	</insert>
	
	<select id="getRSV" parameterType="reservationsVO" resultType="reservationsVO">
		select
			s.type, 
			s.name, 
			s.address, 
			s.addressdetail, 
			s.hostidx, 
			s.thumb, 
			r.* 
			from spaces s, reservations r 
			where s.idx = r.spaceidx
			and residx = #{resIdx}
	</select>
	
	<select id="getRsvFullDates" parameterType="hashmap" resultType="String">
		select date from (
			select date(startdate) as date, sum(rsvhours) as rsvhours
			from reservations
			where spaceidx = #{spaceIdx} and date(startdate) between #{nowDate} and #{afterMonth}
			group by date
			) a	where a.rsvhours = 15;
	</select>
	
	<select id="getRsvHours" parameterType="Map" resultType="Map">
		select startDate, endDate from reservations
		where spaceidx = #{spaceIdx} and date(startdate) = #{date}
	</select>
	
	<select id="getCurrentRsv" parameterType="generalMembersVO" resultType="reservationsVO">
		select 
			a.residx, 
			a.midx, 
			a.spaceidx, 
			a.peoplenum, 
			a.startdate, 
			a.enddate, 
			a.rsvhours, 
			a.resdate, 
			b.idx,
			b.type, 
			b.name, 
			b.address, 
			b.addressDetail,
			b.addr1, 
			b.addr2, 
			b.thumb 
		from reservations a, spaces b
		where a.enddate <![CDATA[>=]]> now()
		and a.spaceidx = b.idx
		and a.midx = #{mIdx}
		order by startdate;
	</select>
	
	<select id="countPastRsv" parameterType="hashmap" resultType="int">
		select count(*)
		from reservations a, spaces b
		where a.spaceidx = b.idx
		and a.midx = #{mIdx}
		<if test="start != null and start != ''">
			<if test="dateType == 'resDate'">
				<if test="end == null or end == ''">
					and date(a.resdate) = #{start}
					order by resdate
				</if>
				<if test="end != null and end != ''">
					and date(a.resdate) <![CDATA[>=]]> #{start}
					and date(a.resdate) <![CDATA[<=]]> #{end}
					order by resdate
				</if>
			</if>
			<if test="dateType == 'startDate'">
				<if test="end == null or end == ''">
					and date(a.startdate) = #{start}
					order by startdate
				</if>
				<if test="end != null and end != ''">
					and date(a.startdate) <![CDATA[>=]]> #{start}
					and date(a.startdate) <![CDATA[<=]]> #{end}
					order by startdate
				</if>
			</if>
		</if>
	</select>
	
	<select id="getPastRsv" parameterType="hashmap" resultType="reservationsVO">
		select
			a.residx,
			a.midx,
			a.spaceidx,
			a.peoplenum,
			a.startdate,
			a.enddate,
			a.rsvhours,
			a.resdate,
			a.cost,
			a.usedPoint,
			a.totalCost,
			b.idx,
			b.type, 
			b.name, 
			b.address, 
			b.addressDetail,
			b.addr1, 
			b.addr2, 
			b.thumb 
		from reservations a, spaces b
		where a.spaceidx = b.idx
		and a.midx = #{mIdx}
		<if test="start != null and start != ''">
			<if test="dateType == 'resDate'">
				<if test="end == null or end == ''">
					and date(a.resdate) = #{start}
					order by resdate
				</if>
				<if test="end != null and end != ''">
					and date(a.resdate) <![CDATA[>=]]> #{start}
					and date(a.resdate) <![CDATA[<=]]> #{end}
					order by resdate
				</if>
			</if>
			<if test="dateType == 'startDate'">
				<if test="end == null or end == ''">
					and date(a.startdate) = #{start}
					order by startdate
				</if>
				<if test="end != null and end != ''">
					and date(a.startdate) <![CDATA[>=]]> #{start}
					and date(a.startdate) <![CDATA[<=]]> #{end}
					order by startdate
				</if>
			</if>
		</if>
		limit #{startRow}, 10;
	</select>
	
	<select id="isReviewExist" parameterType="reservationsVO" resultType="int">
		select count(*) from space_review
		where residx = #{resIdx}
	</select>
	
	<insert id="insertReview" parameterType="spaceReviewVO">
		insert into space_review (
			residx,
			spaceidx,
			<if test="pictureSrc != null">
				picturesrc,
				thumbsrc,
			</if>
			score,
			midx,
			mnickname,
			content
		) values (
			#{resIdx},
			#{spaceIdx},
			<if test="pictureSrc != null">
				#{pictureSrc},
				#{thumbSrc},
			</if>
			#{score},
			#{mIdx},
			#{mNickname},
			#{content}
		)
	</insert>
	
	<insert id="insertQnaQ" parameterType="spaceQnaVO">
		insert into space_qna (
			spaceidx,
			midx,
			mnickname,
			content,
			publicyn
		) values (
			#{spaceIdx},
			#{mIdx},
			#{mNickname},
			#{content},
			#{publicYN}
		)
	</insert>
	
	<select id="countQna" parameterType="spacesVO" resultType="int">
		select count(*) from space_qna
		where spaceidx = #{idx}
	</select>
	
	<select id="qnaList" parameterType="hashMap" resultType="spaceQnaVO">
		select gm.profileSrc, sq.* from general_members gm, space_qna sq
		where gm.midx = sq.midx
		and spaceidx = #{spacesVO.idx}
		order by regDate desc
		limit #{start}, 5
	</select>
</mapper>